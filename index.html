<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <title>ตารางแผนปฎิบัติงาน</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/locale/th.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
  <style>
    body { font-family: 'Sarabun', sans-serif; background-color: #f4f7fa; }
    .container { background-color: #fff; border-radius: 8px; padding: 30px; }
    .swal2-popup { font-family: 'Sarabun', sans-serif; }
  </style>
</head>

<body>
  <div class="container my-5">
    <h1 class="text-center" style="font-size: 24px;">
      ตารางแผนการปฎิบัติงานเจ้าหน้าที่สนับสนุนโครงการสุราภาค4/ประจำเดือน:
    </h1>
    <div id="calendar"></div>
  </div>

  <script>
    function loadCalendarEvents() {
      google.script.run.withSuccessHandler(function(events) {
        $('#calendar').fullCalendar('destroy'); // ล้างก่อนโหลดใหม่
        $('#calendar').fullCalendar({
          header: { left: 'prev,next today', center: 'title', right: 'month,agendaWeek,agendaDay' },
          locale: 'th',
          events: events,
          selectable: true,
          select: function(start) {
            const selectedDate = moment(start).format('YYYY-MM-DD');

            google.script.run.withSuccessHandler(function(row) {
              if (row === -1) {
                Swal.fire("ข้อผิดพลาด", "ไม่สามารถเพิ่มเหตุการณ์! วันที่ไม่มีอยู่ในระบบ", "error");
                return;
              }

              Swal.fire({
                title: 'เพิ่มเหตุการณ์',
                html: `  
                  <input id="eventTitle" class="swal2-input" list="eventOptions" placeholder="เลือกหรือพิมพ์ชื่อเหตุการณ์">
                  <datalist id="eventOptions">
                    <option value="ศูนย์ขอนแก่น">
                    <option value="ศูนย์สกลนคร">
                    <option value="ศูนย์อุดรธานี">
                    <option value="ศูนย์ชัยภูมิ">
                    <option value="หนองคาย">
                    <option value="เลย">
                    <option value="นครพนม">
                    <option value="มุกดาหาร">
                    <option value="กาฬสินธุ">
                    <option value="มหาสารคาม">
                    <option value="ประชุมทีมขาย">
                    <option value="อบรพนักงานใหม่">
                  </datalist>
                  <input type="date" id="startDate" class="swal2-input" value="${selectedDate}">
                  <input type="date" id="endDate" class="swal2-input">
                `,
                showCancelButton: true,
                confirmButtonText: 'บันทึก',
                preConfirm: () => {
                  const title = document.getElementById('eventTitle').value;
                  const startDate = document.getElementById('startDate').value;
                  const endDate = document.getElementById('endDate').value || startDate;
                  if (!title) { 
                    Swal.showValidationMessage('กรุณากรอกชื่อเหตุการณ์'); 
                    return false; 
                  }
                  return { title, startDate, endDate };
                }
              }).then((result) => {
                if (result.isConfirmed) {
                  google.script.run.withSuccessHandler(() => {
                    Swal.fire("สำเร็จ!", "เพิ่มเหตุการณ์แล้ว", "success");
                    loadCalendarEvents(); // โหลดข้อมูลใหม่ ไม่ต้องรีเฟรช
                  }).addEvent(result.value.title, result.value.startDate, result.value.endDate);
                }
              });
            }).findRowByDate(selectedDate);
          },
          eventClick: function(event) {
            Swal.fire({
              title: event.title,
              html: `<p><strong>เริ่ม:</strong> ${moment(event.start).format('DD/MM/YYYY')}</p>
                     <p><strong>สิ้นสุด:</strong> ${event.end ? moment(event.end).format('DD/MM/YYYY') : 'ไม่ระบุ'}</p>`,
              icon: 'info',
              showCancelButton: true,
              confirmButtonText: 'ล้างค่าเหตุการณ์',
            }).then((result) => {
              if (result.isConfirmed) {
                var startDate = moment(event.start).format('YYYY-MM-DD');
                google.script.run.withSuccessHandler(function(message) {
                  Swal.fire("ล้างสำเร็จ!", message, "success");
                  loadCalendarEvents(); // โหลดข้อมูลใหม่ ไม่ต้องรีเฟรช
                }).deleteEventByStartDate(startDate);
              }
            });
          }
        });
      }).getEvents();
    }

    $(document).ready(function() { 
      loadCalendarEvents(); 
    });
  </script>
</body>
</html>

